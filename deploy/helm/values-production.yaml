# Production values for savvy
# Usage: helm install savvy ./helm/savvy -f helm/savvy/values-production.yaml

replicaCount: 2

image:
  repository: ghcr.io/sbaerlocher/savvy
  pullPolicy: IfNotPresent
  tag: "1.1.0"

resources:
  limits:
    cpu: "2"
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 256Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

config:
  goEnv: production
  enableCards: true
  enableVouchers: true
  enableGiftCards: true
  enableLocalLogin: false  # OAuth only in production
  enableRegistration: false  # Invite-only
  otelEnabled: true
  otelExporterOtlpEndpoint: "grafana-alloy.observability.svc.cluster.local:4318"

database:
  external:
    enabled: true
    host: "postgres-postgresql.database.svc.cluster.local"
    port: 5432
    name: "savvy_production"
    user: "savvy"
    sslMode: "require"
    existingSecret: "savvy-db"
    existingSecretKey: "password"

externalSecrets:
  enabled: true
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-secret-store
    kind: ClusterSecretStore
  secrets:
    - name: savvy-session
      key: "savvy-session-secret"
      property: password
      target:
        name: savvy-session
        key: SESSION_SECRET
    - name: savvy-db
      key: "savvy-db-password"
      property: password
      target:
        name: savvy-db
        key: password

oauth:
  enabled: true
  clientId: "savvy-production"
  issuer: "https://auth.example.com/application/o/savvy/"
  redirectUrl: "https://savvy.example.com/callback"
  existingSecret: "savvy-oauth"
  existingSecretKey: "client-secret"

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "100"
  hosts:
    - host: savvy.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: savvy-tls
      hosts:
        - savvy.example.com

monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
    labels:
      prometheus: kube-prometheus

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - savvy
          topologyKey: kubernetes.io/hostname
