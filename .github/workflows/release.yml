---
name: Software Release

"on":
  push:
    tags: ["v*"]

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  go-release:
    name: Go Binaries (Linux only)
    uses: sbaerlocher/.github/.github/workflows/release-go.yml@main
    with:
      pre-build-commands: 'go install github.com/a-h/templ/cmd/templ@v0.3.977'

  docker-release:
    name: Docker Multi-Platform
    needs: go-release
    uses: sbaerlocher/.github/.github/workflows/release-docker.yml@main
    with:
      image-name: 'sbaerlocher/container/savvy'
      dockerfile: 'Dockerfile'
      platforms: 'linux/amd64,linux/arm64'
      registry: 'ghcr.io'
      push: true
      build-args: |
        VERSION=${{ github.ref_name }}
      docker-metadata-tags: |
        type=semver,pattern={{version}}
        type=semver,pattern={{major}}.{{minor}}
        type=semver,pattern={{major}}
        type=raw,value=latest,enable={{is_default_branch}}

  helm-release:
    name: Helm Chart
    needs: docker-release
    uses: sbaerlocher/.github/.github/workflows/release-helm.yml@main
    with:
      chart-path: 'deploy/helm'
      chart-name: 'savvy'
      registry: 'ghcr.io'
      registry-path: '${{ github.repository_owner }}/chart'
      version: '${{ github.ref_name }}'
    secrets:
      registry-token: '${{ secrets.GITHUB_TOKEN }}'
