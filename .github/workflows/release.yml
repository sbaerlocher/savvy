---
name: Software Release

"on":
  push:
    tags: ["v*"]

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  go-release:
    name: Go Binaries (Linux only)
    uses: sbaerlocher/.github/.github/workflows/release-go.yml@main

  docker-release:
    name: Docker Multi-Platform
    needs: go-release
    uses: sbaerlocher/.github/.github/workflows/release-docker.yml@main
    with:
      image-name: 'sbaerlocher/savvy'
      dockerfile: 'Dockerfile'
      platforms: 'linux/amd64,linux/arm64'
      registry: 'ghcr.io'
      push: true

  helm-release:
    name: Helm Chart
    needs: docker-release
    uses: sbaerlocher/.github/.github/workflows/release-helm.yml@main
    with:
      chart-path: 'deploy/helm'
      chart-name: 'savvy'
      registry: 'ghcr.io'
      registry-path: '${{ github.repository_owner }}'
      version: '${{ github.ref_name }}'
    secrets:
      registry-token: '${{ secrets.GITHUB_TOKEN }}'
